# .github/workflows/sync-azure-specs.yml
name: Sync Azure API Specifications

on:
  schedule:
    # Run daily at 2 AM UTC
    - cron: '0 2 * * *'

  workflow_dispatch:
    inputs:
      force_regenerate:
        description: 'Force regenerate all services'
        required: false
        default: 'false'

jobs:
  sync-specs:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write

    steps:
      - name: Checkout Mazure
        uses: actions/checkout@v4
        with:
          submodules: true

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install Dependencies
        run: |
          pip install -e ".[dev]"
          npm install -g autorest

      - name: Clone/Update Azure REST API Specs
        run: |
          if [ ! -d "specs/azure-rest-api-specs" ]; then
            git clone https://github.com/Azure/azure-rest-api-specs.git \
              specs/azure-rest-api-specs --depth=1
          else
            cd specs/azure-rest-api-specs
            git pull origin main
            cd ../..
          fi

      - name: Run Sync Engine
        id: sync
        run: |
          python -m mazure.sync.sync_command \
            --specs-path=specs/azure-rest-api-specs \
            --output=sync_report.json \
            --update-tasks=sync/pending_updates.json

          # Check if changes were detected
          if [ -s sync/pending_updates.json ]; then
            echo "changes_detected=true" >> $GITHUB_OUTPUT
          else
            echo "changes_detected=false" >> $GITHUB_OUTPUT
          fi

      - name: Generate Code for New/Changed Specs
        if: steps.sync.outputs.changes_detected == 'true'
        run: |
          python -m mazure.sync.codegen_command \
            --tasks-file=sync/pending_updates.json \
            --specs-path=specs/azure-rest-api-specs \
            --auto-approve=true

      - name: Run Tests
        if: steps.sync.outputs.changes_detected == 'true'
        run: |
          pytest tests/ -v --cov=mazure --cov-report=xml

      - name: Generate Coverage Report
        if: steps.sync.outputs.changes_detected == 'true'
        run: |
          python -m mazure.sync.coverage_report \
            --output=coverage_report.md

      - name: Create Pull Request
        if: steps.sync.outputs.changes_detected == 'true'
        uses: peter-evans/create-pull-request@v5
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: |
            Auto-sync: Update Azure API implementations

            This PR contains automatically generated code updates based on
            changes to Azure REST API specifications.
          branch: auto-sync-${{ github.run_number }}
          title: "ðŸ”„ Auto-sync: Azure API Specification Updates"
          body: |
            ## Azure API Specification Sync

            This PR was automatically generated by the sync workflow.

            ### Changes Summary

            ${{ steps.sync.outputs.summary }}

            ### Coverage Report

            See attached `coverage_report.md`

            ### Action Required

            - [ ] Review generated code
            - [ ] Run integration tests
            - [ ] Update documentation if needed
          labels: |
            auto-sync
            api-update
          reviewers: |
            @maintainer-team

      - name: Upload Sync Report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: sync-report-${{ github.run_number }}
          path: |
            sync_report.json
            coverage_report.md
            sync/pending_updates.json

  notify:
    needs: sync-specs
    runs-on: ubuntu-latest
    if: failure()
    steps:
      - name: Notify on Failure
        uses: 8398a7/action-slack@v3
        with:
          status: ${{ job.status }}
          text: 'Azure API sync failed! Check workflow logs.'
          webhook_url: ${{ secrets.SLACK_WEBHOOK }}
